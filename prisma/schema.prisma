// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users of the platform
model User {
  id            String    @id @default(cuid())
  mobile        String    @unique
  name          String?
  email         String?   @unique
  isVerified    Boolean   @default(false)
  isAdmin       Boolean   @default(false)
  otp           String?   // For OTP verification
  otpExpiresAt  DateTime? // OTP expiry time
  
  // Loyalty Program
  loyaltyLevel  LoyaltyLevel @default(BRONZE) // BRONZE, SILVER, GOLD
  totalTrips    Int       @default(0)
  loyaltyPoints Int       @default(0)
  
  // Referral Program
  referralCode  String?   @unique // Personal referral code
  referredBy    String?   // Who referred this user
  referralCount Int       @default(0)
  referralEarnings Float    @default(0) // Total earned from referrals
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  bookings      Booking[]
  notifications Notification[]
  loyaltyRewards LoyaltyReward[]
  tShirtOrders  TShirtOrder[]
  referralRewards ReferralReward[] @relation("ReferrerRewards")
  referredRewards ReferralReward[] @relation("ReferredRewards")
  
  @@map("users")
}

// Temple destinations
model Temple {
  id          String   @id @default(cuid())
  name        String
  description String?
  city        String
  state       String
  image       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  trips       Trip[]
  
  @@map("temples")
}

// Bus routes
model Route {
  id          String   @id @default(cuid())
  origin      String
  destination String
  distance    Float?   // in km
  duration    Float?   // in hours
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  trips       Trip[]
  
  @@map("routes")
}

// Trip schedules
model Trip {
  id              String   @id @default(cuid())
  routeId         String
  templeId        String
  title           String
  description     String?
  departureDate   DateTime
  returnDate      DateTime
  departureTime   String   // HH:MM format
  returnTime      String   // HH:MM format
  totalSeats      Int
  availableSeats  Int
  pricePerSeat    Float
  advancePrice    Float?
  busType         String   // AC, Non-AC, Deluxe, etc.
  boardingPoints  String   // JSON array of pickup points
  inclusions      String?  // JSON array of what's included
  exclusions      String?  // JSON array of what's excluded
  cancellationPolicy String?
  emergencyContact String?
  isActive        Boolean  @default(true)
  status          String   @default("UPCOMING") // UPCOMING, FULL, CANCELLED, COMPLETED
  
  // Package Information
  packageId       String?  // Associated package
  includesTShirt   Boolean  @default(false)
  includesInsurance Boolean @default(false)
  includesMeals   Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  route           Route @relation(fields: [routeId], references: [id])
  temple          Temple @relation(fields: [templeId], references: [id])
  bookings        Booking[]
  loyaltyRewards  LoyaltyReward[]
  
  @@map("trips")
}

// Bookings
model Booking {
  id              String   @id @default(cuid())
  userId          String
  tripId          String
  bookingId       String   @unique // e.g., WKD-2024-001
  passengerCount  Int
  passengerDetails String  // JSON array of passenger info
  totalAmount     Float
  advanceAmount   Float?
  paymentStatus   String   @default("PENDING") // PENDING, ADVANCE_PAID, FULL_PAID, REFUNDED
  paymentId       String?  // Razorpay payment ID
  bookingStatus   String   @default("CONFIRMED") // CONFIRMED, CANCELLED, COMPLETED
  seats           String   // JSON array of seat numbers
  qrCode          String?
  specialRequests String?
  
  // Package Information
  packageId       String?
  tShirtSize     String?  // S, M, L, XL, XXL
  tShirtOrdered   Boolean  @default(false)
  insuranceId     String?
  hasInsurance    Boolean  @default(false)
  
  // Referral Information
  referralCode    String?  // Used referral code if any
  referralDiscount Float?  // Discount applied from referral
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User @relation(fields: [userId], references: [id])
  trip            Trip @relation(fields: [tripId], references: [id])
  payments        Payment[]
  tShirtOrder     TShirtOrder?
  insuranceCoverage InsuranceCoverage?
  referralRewards ReferralReward[]
  
  @@map("bookings")
}

// Payment records
model Payment {
  id              String   @id @default(cuid())
  bookingId       String
  amount          Float
  type            String   // ADVANCE, FULL, REFUND
  status          String   @default("PENDING") // PENDING, SUCCESS, FAILED, REFUNDED
  paymentMethod   String   // UPI, CARD, NET_BANKING
  gatewayId       String?  // Razorpay payment ID
  gatewayOrderId  String?  // Razorpay order ID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  booking         Booking @relation(fields: [bookingId], references: [id])
  
  @@map("payments")
}

// Notifications
model Notification {
  id              String   @id @default(cuid())
  userId          String?
  tripId          String?
  bookingId       String?
  type            String   // BOOKING_CONFIRMED, TRIP_REMINDER, PAYMENT_RECEIVED, etc.
  title           String
  message         String
  channels        String   // JSON array: SMS, WHATSAPP, EMAIL, PUSH
  status          String   @default("PENDING") // PENDING, SENT, FAILED
  sentAt          DateTime?
  createdAt       DateTime @default(now())
  
  // Relations
  user            User? @relation(fields: [userId], references: [id])
  
  @@map("notifications")
}

// Admin settings
model Setting {
  id              String   @id @default(cuid())
  key             String   @unique
  value           String
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("settings")
}

// Loyalty Level Enum
enum LoyaltyLevel {
  BRONZE
  SILVER
  GOLD
}

// Loyalty Rewards
model LoyaltyReward {
  id          String   @id @default(cuid())
  userId      String
  level       LoyaltyLevel
  tripId      String?  // Trip for which reward was given
  rewardType  String   // DISCOUNT, POINTS, PRASAD_KIT, VIP_BOARDING
  rewardValue Float   // Discount amount or points earned
  description String?
  isUsed      Boolean  @default(false)
  usedAt      DateTime?
  createdAt   DateTime @default(now())
  
  // Relations
  user        User @relation(fields: [userId], references: [id])
  trip        Trip? @relation(fields: [tripId], references: [id])
  
  @@map("loyalty_rewards")
}

// Referral Rewards
model ReferralReward {
  id            String   @id @default(cuid())
  referrerId    String   // User who referred
  referredId    String   // User who was referred
  bookingId     String   // Booking that triggered reward
  referrerAmount Float   // Amount given to referrer
  referredAmount Float   // Discount given to referred user
  status        String   @default("PENDING") // PENDING, PAID, EXPIRED
  createdAt     DateTime @default(now())
  paidAt        DateTime?
  
  // Relations
  referrer      User @relation("ReferrerRewards", fields: [referrerId], references: [id])
  referred      User @relation("ReferredRewards", fields: [referredId], references: [id])
  booking       Booking @relation(fields: [bookingId], references: [id])
  
  @@map("referral_rewards")
}

// Customer Packages
model CustomerPackage {
  id            String   @id @default(cuid())
  name          String   // Package name (e.g., "Premium Devotee Package")
  description   String
  basePrice     Float   // Base price without package
  packagePrice  Float   // Price with package included
  savings       Float   // How much customer saves
  features      String   // JSON array of included features
  
  // Package Contents
  includesTShirt    Boolean @default(false)
  includesInsurance Boolean @default(false)
  includesMeals    Boolean @default(false)
  includesLoyalty  Boolean @default(true)
  
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("customer_packages")
}

// T-Shirt Orders
model TShirtOrder {
  id          String   @id @default(cuid())
  userId      String
  bookingId   String   @unique
  size        String   // S, M, L, XL, XXL
  status      String   @default("PENDING") // PENDING, CONFIRMED, DELIVERED
  deliveredAt DateTime?
  createdAt   DateTime @default(now())
  
  // Relations
  user        User @relation(fields: [userId], references: [id])
  booking     Booking @relation(fields: [bookingId], references: [id])
  
  @@map("tshirt_orders")
}

// Insurance Coverage
model InsuranceCoverage {
  id            String   @id @default(cuid())
  bookingId     String   @unique
  provider      String   // HDFC ERGO, ICICI Lombard, etc.
  policyNumber  String?
  coverageType  String   // TRAVEL_ACCIDENT, MEDICAL_EMERGENCY
  coverageAmount Float
  premium       Float
  status        String   @default("ACTIVE") // ACTIVE, EXPIRED, CANCELLED
  startDate     DateTime
  endDate       DateTime
  createdAt     DateTime @default(now())
  
  // Relations
  booking       Booking @relation(fields: [bookingId], references: [id])
  
  @@map("insurance_coverage")
}